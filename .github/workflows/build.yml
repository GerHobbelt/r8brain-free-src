name: Build Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-macos:
    runs-on: macos-10.15
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          persist-credentials: false

      - name: Compile
        run: |
          ${{ env.CC }} ${{ env.CFLAGS }} -c pffft_double/pffft_double.c -o pffft_double.o
          ${{ env.CPP }} ${{ env.CPPFLAGS }} -c r8bbase.cpp -o r8bbase.o
          ${{ env.AR }} rcs libr8brain-macos10.a pffft_double.o r8bbase.o
        env:
          AR: ar
          CC: clang
          CPP: clang
          CFLAGS: -std=c17 -O3 -fstrict-aliasing -pedantic -Wall -Wextra
          CPPFLAGS: -std=c++17 -O3 -fstrict-aliasing -pedantic -Wall -Wextra

      - name: Upload build output
        uses: actions/upload-artifact@v2
        with:
          name: build-output-macos10
          path: |
            libr8brain-macos10.a
            LICENSE

  build-android:
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          persist-credentials: false

      - name: Compile
        run: |
          ${{ env.CC }} ${{ env.CFLAGS }} -c pffft_double/pffft_double.c -o pffft_double.o
          ${{ env.CPP }} ${{ env.CPPFLAGS }} -c r8bbase.cpp -o r8bbase.o
          ${{ env.AR }} rcs libr8brain-android30.a pffft_double.o r8bbase.o
        env:
          AR: /usr/local/lib/android/sdk/ndk-bundle/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android-ar
          CC: /usr/local/lib/android/sdk/ndk-bundle/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android30-clang
          CPP: /usr/local/lib/android/sdk/ndk-bundle/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android30-clang
          CFLAGS: -std=c17 -O3 -fstrict-aliasing -pedantic -Wall -Wextra
          CPPFLAGS: -std=c++17 -O3 -fstrict-aliasing -pedantic -Wall -Wextra

      - name: Upload build output
        uses: actions/upload-artifact@v2
        with:
          name: build-output-android30
          path: libr8brain-android30.a

  create-release:
    runs-on: ubuntu-20.04
    needs: [build-macos, build-android]
    steps:
      - name: Get build output macos10
        uses: actions/download-artifact@v2
        with:
          name: build-output-macos10

      - name: Get build output android30
        uses: actions/download-artifact@v2
        with:
          name: build-output-android30

      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            libr8brain-macos10.a
            libr8brain-android30.a
            LICENSE
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
